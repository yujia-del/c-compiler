# C 语言编译器

一个完整的C语言子集编译器，可将C语言测试程序编译为目标汇编代码，并通过汇编器转换为可执行的二进制程序。

## 项目概述

本项目实现了一个C语言子集的编译器，支持从源代码到汇编代码的完整编译流程。编译器采用模块化设计，包含词法分析、语法分析、语义分析、中间代码生成、代码优化和目标代码生成等阶段。

### 支持的语言特性

#### 基本数据类型
- `int`：整型数据类型

#### 语句支持
- 注释：`//` 单行注释和 `/* */` 多行注释
- 变量声明和赋值
- 循环语句：`while` 和 `for`
- 条件判断：`if` 和 `if-else`
- 输入输出函数

#### 运算支持
- **算术运算**：`+`, `-`, `*`, `/`, `%`, `^`
- **关系运算**：`==`, `>`, `<`, `>=`, `<=`, `!=`
- **逻辑运算**：`&&`（与）, `||`（或）, `!`（非）

#### 高级特性
- 数组运算（一维数组）
- 指针运算
- 结构体支持
- 函数调用

### 编译器功能模块

1. **词法分析** - 将源代码转换为词法单元序列
2. **语法分析** - 构建抽象语法树（AST）
3. **中间代码生成** - 生成四元式中间表示
4. **类型检查** - 静态类型检查
5. **代码优化** - 中间代码优化
6. **目标代码生成** - 生成x86汇编代码

## 项目要求与评分标准

### 主要功能（90分）
- 词法分析：20分
- 语法分析（构建语法树）：30分
- 中间代码生成（四元式）：10分
- 类型检查：10分
- 代码优化：10分
- 文档与演示：20分

### 附加功能（10分）
- 错误分析：5分
- 汇编程序：5分

## 快速开始

### 环境要求

#### 操作系统支持
- **Ubuntu LTS 18.04+** 或其他 GNU/Linux 发行版
- **macOS** 10.14+

#### 依赖安装

**Ubuntu/Linux:**
```bash
sudo apt update
sudo apt install nasm flex bison gcc-multilib build-essential
```

**macOS:**
```bash
# 使用 Homebrew 安装
brew install nasm flex bison gcc
```

### 构建项目

#### 完整构建流程
```bash
# 在项目根目录执行以下命令
make grammar    # 生成语法分析器
make            # 编译项目
make build      # 创建构建目录

# 或使用单行命令
make grammar&make&make build
```

构建过程将：
1. 使用 flex 和 bison 生成词法分析和语法分析器
2. 编译所有源文件生成可执行文件 `parser`
3. 创建 `build` 目录并复制所有必要文件

#### 清理构建产物
```bash
make clean
```

清理操作将删除：
- 语法分析文件夹 (`./output/`)
- 所有目标文件 (`.o` 文件)
- 可执行文件 (`parser`)
- 构建文件夹 (`build/`)
- 汇编IO对象文件

### 使用编译器

#### 基本用法

#### 编译测试程序
```bash
make array
make loop
make fibo
make struct
make swap    # 编译并运行 swap.c
```
## 文件目录说明

1. `common`目录
    包含核心功能类文件，其中trees.h为主要头文件，集成了所有语法树相关类的引用。
    * `symbol`子目录：包含符号表类及函数符号表类的实现
    * `trees`子目录：包含抽象语法树（AST）相关类的实现
    * `util`子目录：包含工具类、中间代码生成器和汇编代码生成器

2. `test`目录
    包含测试用C语言源文件（如swap.c、array.c等）及其生成的中间文件

3. `build`目录
    存放编译后的可执行文件和测试环境

4. `example`目录
    包含Makefile模板，用于在build目录中编译测试程序

5. `output`目录
    存放flex和bison生成的语法分析器相关文件

6. `Makefile`：项目主构建文件（支持Linux和MacOS）

## 关键类说明

### SymbolTable类（./common/symbol/symbol.h）

|方法名|返回值|参数|功能|参数说明|
|:----:|:----:|:--:|:--:|:------:|
|`SymbolTable`|无|`bool isFun`|构造函数，创建空符号表|是否为函数作用域|
|`createChildTable`|`SymbolTable*`|`bool isFun`|创建并返回子符号表|子作用域是否为函数|
|`addSymbol`|`int`|`string idName, symbolType idType`|添加符号，成功返回0，重复返回-1|符号名和符号类型|
|`findSymbol`|`symbol*`|`const string name`|查找符号（递归到父表）|符号名|

> 注意：中间代码生成部分只需使用idName和idType属性，无需修改offset和index值

## 新功能说明

1. **语法树生成**
   - 支持将抽象语法树（AST）保存到.ast文件
   - 包含完整节点结构、层次关系和属性信息

2. **四元式格式优化**
   - 采用固定宽度列对齐格式
   - 各字段宽度统一为15个字符，提高可读性
3. **错误分析**
   - 支持语法错误和语义错误检测
   - 提供详细的错误位置信息（行号、列号）
4. **汇编代码生成**
   - 支持将四元式中间代码转换为x86汇编代码
   - 包含必要的栈帧设置和函数调用规范
5. **结构体支持**
   - 支持定义和使用结构体类型
   - 允许结构体成员访问和赋值
6. **数组支持**
   - 支持一维数组声明和初始化
   - 允许数组元素访问和赋值
7. **函数支持**
   - 支持函数定义和调用
   - 允许参数传递和返回值处理

## 编译测试流程

编译单个测试程序的过程：
1. 使用parser将C代码转换为汇编代码
2. 使用nasm将汇编代码转换为目标文件
3. 生成最终的可执行文件

## 注意事项

1. 本编译器实现了C语言的一个子集，支持基本数据类型和控制结构
2. 构建顺序：必须先执行`make grammar`，然后`make`，最后`make build`
3. macOS环境需通过Homebrew安装所有依赖
4. 测试程序通过专用汇编I/O模块实现输入输出功能
